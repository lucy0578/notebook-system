# 差分传输 API 文档

本文档描述了笔记内容的差分传输 API，使用 diff-match-patch 算法和 Quill Delta 格式实现高效数据传输和协作编辑。

## 概述

为了减少网络传输量并支持协作编辑功能，本 API 使用差分传输机制。客户端仅发送文档变更的部分（补丁或 Delta），服务器应用这些变更而不是替换整个文档内容。

## API 端点

### 1. 获取笔记内容

```
GET /noteContent/{notebookId}
```

**响应结构：**

```json
{
  "code": 1,
  "data": {
    "id": "笔记ID",
    "notebookId": "笔记本ID",
    "content": "完整笔记内容",
    "version": 1
  },
  "msg": "获取成功"
}
```

### 2. 保存笔记内容（Delta 差分方式）

```
POST /noteContent_create
```

**请求体：**

```json
{
  "id": "笔记ID（可选）",
  "notebookId": "笔记本ID",
  "version": 5,
  "delta": {
    "ops": [
      { "retain": 11 },
      { "insert": "!" }
    ]
  },
  "content": "完整内容（向下兼容）"
}
```

**或（向下兼容的 diffPatch 方式）：**

```json
{
  "id": "笔记ID（可选）",
  "notebookId": "笔记本ID",
  "version": 1,
  "diffPatch": "差分补丁文本",
  "content": "完整内容（向下兼容）"
}
```

**响应结构：**

```json
{
  "code": 1,
  "data": {
    "id": "笔记ID",
    "version": 2
  },
  "msg": "保存成功"
}
```

**响应状态码：**

- `code=1`: 保存成功
- `code=0`: 保存失败，通常在 `msg` 字段中包含详细信息如"笔记已被更新"

### 3. WebSocket 协议

WebSocket 连接用于实时通知文档变更。

**连接端点：**

```
ws://localhost:8080/ws/{clientId}
```

**消息格式：**

1. 客户端发送到服务器的消息：

```json
{
  "msg": "新版本笔记保存，请更新",
  "notebookId": "笔记本ID",
  "clientId": "客户端ID"
}
```

2. 服务器广播到其他客户端的消息（同上）

## 差分算法说明

本 API 支持两种差分传输方式：

1. **Quill Delta 格式**：基于 Quill 编辑器的操作变更记录，以 JSON 格式发送。具有更好的结构化特性，适合复杂文档编辑。

2. **diff-match-patch 算法**：Google 的文本差异处理算法。差分补丁使用该库的 `patch_toText()` 和 `patch_fromText()` 方法序列化和反序列化。

### Quill Delta 格式说明

Delta 是 Quill 编辑器内容变更的表示方式，它由一系列操作（operations）组成：

- `retain`：保持一定数量的字符不变
- `insert`：在当前位置插入文本或内联对象
- `delete`：删除一定数量的字符
- `attributes`：应用格式化属性

例如，以下 Delta 表示"在第 11 个字符后插入一个感叹号"：

```json
{
  "ops": [
    { "retain": 11 },
    { "insert": "!" }
  ]
}
```

### 服务器端处理流程

1. 接收客户端发送的差分（Delta 或 diffPatch）
2. 解析差分内容
3. 获取当前文档的最新版本
4. 应用差分到文档
5. 检查应用是否成功
6. 如果成功，保存新版本并更新版本号
7. 如果失败，返回错误并建议客户端获取最新版本

### 客户端处理流程

1. 获取初始文档内容和版本号
2. 用户编辑文档
3. 保存时，计算差异（Delta 或 diffPatch）并发送到服务器
4. 如果服务器接受更改，更新本地版本号
5. 如果服务器拒绝（版本冲突），获取最新版本并显示差异
6. 用户选择接受或拒绝远程更改

## 协作编辑处理

当多个用户同时编辑同一文档时：

1. 用户A修改并保存文档
2. 服务器保存更改并通过WebSocket通知其他用户
3. 用户B收到通知，获取最新版本
4. 系统计算用户B当前版本与最新版本的差异
5. 差异以高亮方式显示（新增内容为绿色，删除内容为红色带删除线）
6. 用户B可以选择"应用"或"拒绝"这些更改

## 错误处理

1. 版本冲突：当客户端尝试更新过期版本时，服务器返回错误
2. 补丁应用失败：当补丁无法应用到当前文档时，服务器返回错误
3. Delta应用失败：当Delta操作无法应用到当前文档时，服务器返回错误
4. 网络错误：WebSocket连接中断时客户端应尝试重新连接 